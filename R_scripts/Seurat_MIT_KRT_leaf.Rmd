---
title: "Integrate UGA and MPI single cell analysis with mitr_v1.asm"
author: "Anne Pavia"
output:
  html_document:
    df_print: paged
#Notes: 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/scratch/ac05869/MIT_KRT_sc_analysis/Rwd")
library(tidyverse)
library(ggplot2)
library(Seurat) 
library(readxl)
library(RColorBrewer)
library(viridis)
library(svglite) 
library(patchwork)
library(cowplot)
library(ggpubr)
library(showtext)
showtext_auto()
```
Notes: AA and AB are reps of KRT uga leaf single cell data. AH and AI are reps of mpi leaf single cell data.


# Load RDS Object post doublet filtering
```{r}
AA_clean <- readRDS("/scratch/ac05869/MIT_KRT_sc_analysis/seurat_data/KRT_AA_doublets_removed_21feb25.rds")
AB_clean <- readRDS("/scratch/ac05869/MIT_KRT_sc_analysis/seurat_data/KRT_AB_doublets_removed_21feb25.rds")
AH_clean <- readRDS("/scratch/ac05869/MIT_KRT_sc_analysis/seurat_data/MIT_AH_doublets_removed_21feb25.rds")
AI_clean <- readRDS("/scratch/ac05869/MIT_KRT_sc_analysis/seurat_data/MIT_AI_doublets_removed_21feb25.rds")

AA_clean$source <- "UGA"
AB_clean$source <- "UGA"
AH_clean$source <- "MPI"
AI_clean$source <- "MPI"
```

# Re-Clustering Cleaned Data 

Now that we have a clean dataset we need to re-cluster things to account for the removal of doublets 
We can either re-run the above clustering steps for single samples OR we can integrate our replicates together at the same time

## Normalize the Data
```{r}

#Default = LogNormalize

AA_clean <- NormalizeData(AA_clean)
AB_clean <- NormalizeData(AB_clean)
AH_clean <- NormalizeData(AH_clean)
AI_clean <- NormalizeData(AI_clean)
```

# Integrate all 4 reps at once
## Integration via reciprocal PCA (RPCA)
###Data Prep

```{r}
leaf.list <- list(AA_clean, AB_clean, AH_clean, AI_clean)

# normalize and identify variable features for each dataset independently
leaf.list <- lapply(X = leaf.list, FUN = function(x) {
    x <- NormalizeData(x)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 3000)
})

# select features that are repeatedly variable across datasets for integration run PCA on each dataset using these features
features <- SelectIntegrationFeatures(object.list = leaf.list, nfeatures = 3000)
leaf.list <- lapply(X = leaf.list, FUN = function(x) {
    x <- ScaleData(x, features = features, verbose = FALSE)
    x <- RunPCA(x, features = features, verbose = FALSE)
})
```

### Integration 
```{r}
leaf.anchors <- FindIntegrationAnchors(object.list = leaf.list, anchor.features = features, reduction = "rpca")

# this command creates an 'integrated' data assay
leaf.combined <- IntegrateData(anchorset = leaf.anchors)

# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(leaf.combined) <- "integrated"
```

## Stats
```{r}
leaf.combined

summary(leaf.combined$nFeature_RNA)
summary(leaf.combined$nCount_RNA)

```

## Scale the Data
```{r}
leaf.combined.genes <- rownames(leaf.combined)
leaf.combined <- ScaleData(leaf.combined, features = leaf.combined.genes)
```

## PCA
```{r}
leaf.combined$Run <- leaf.combined@meta.data$orig.ident
leaf.combined <- RunPCA(leaf.combined, npcs = 75, features = VariableFeatures(object = leaf.combined), verbose = FALSE) # run PCA
```

```{r}
ElbowPlot(leaf.combined, ndims = 75)
```

## Call Clusters
```{r}
leaf.combined <- FindNeighbors(leaf.combined, dims = 1:50) #adjust dims based on elbow plot above
leaf.combined <- FindClusters(leaf.combined, resolution = 0.4) #adjustable resolution value. Check back and forth until it looks good
leaf.combined <- RunUMAP(leaf.combined, dims = 1:50)
```

## Make UMAP Plots

### By Run

```{r}
UMAP1 <- DimPlot(leaf.combined, reduction = "umap", label = T, label.size = 12, repel = T, split.by = "Run") +
  theme_void() +
  theme(
    text = element_text(size = 26, color = "black", face = "bold"),
    legend.position = "none",
    title = element_text(size = 20)
  ) +
  ggtitle("Grouped by Replicates\n")

UMAP1 #check to see that there are the same number of cluster in each rep: KRT_AB does not have cluster 23

ggsave("../seurat_out/KRT_MIT_leaf_integrated_umap_by_run.png", height = 6, width = 18, bg = "white")
```
### By source

```{r}
UMAP2 <- DimPlot(leaf.combined, reduction = "umap", label = T, label.size = 12, repel = T, split.by = "source") +
  theme_void() +
  theme(
    text = element_text(size = 26, color = "black", face = "bold"),
    legend.position = "none",
    title = element_text(size = 20)
  ) +
  ggtitle("Grouped by Source")

UMAP2 #check to see that there are the same number of cluster in each rep: KRT_AB does not have cluster 23

ggsave("../seurat_out/KRT_MIT_leaf_integrated_umap_by_source.png", height = 6, width = 18, bg = "white")
```



### Combined
```{r}
UMAP3 <- DimPlot(leaf.combined, reduction = "umap", label = T, label.size = 12, repel = T) +
  theme_void() +
  theme(
    text = element_text(size = 26, color = "black", face = "bold"),
    legend.position = "none",
    title = element_text(size = 20)
  )
UMAP3
ggsave("../seurat_out/KRT_MIT_leaf_integrated_umap_all_together.png", height = 8, width = 12, bg = "white")
```

## Stats - Integrated Clusters
```{r}
#Cells in each cluster
table(Idents(leaf.combined))

# Cells in each replicate
table(leaf.combined$orig.ident)

#How does cluster membership vary by replicate?
table(Idents(leaf.combined), leaf.combined$orig.ident)

#How does cluster membership vary by source?
table(Idents(leaf.combined), leaf.combined$orig.ident)
```

## Save cleaned integrated RDS Object
```{r}
#saveRDS(leaf.combined, file = "/scratch/ac05869/MIT_KRT_sc_analysis/seurat_data/KRT_MIT_cleaned_integrated_seurat_21feb25.rds")

leaf.combined <- readRDS("/scratch/ac05869/MIT_KRT_sc_analysis/seurat_data/KRT_MIT_cleaned_integrated_seurat_21feb25.rds")
```

# Create Matrices
## Find Markers 
```{r}
DefaultAssay(leaf.combined) <- "RNA"

leaf.combined = JoinLayers(leaf.combined)

leaf.combined.markers <- FindAllMarkers(leaf.combined, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25) #min.pct is the minimum fraction that cells cluster needs to be expressing that gene for it to count. logfc.threshhold is the log-fold change in expression between clusters expressing that gene

leaf.combined.markers %>% group_by(cluster)
write.table(leaf.combined.markers, "/scratch/ac05869/MIT_KRT_sc_analysis/seurat_out/KRT_MIT_clean_integrated_all_markers_minpct0.25_minlfc0.25_21feb25.txt", quote = FALSE, sep = "\t", row.names = FALSE)
#write_excel_csv("/scratch/ac05869/MIT_KRT_sc_analysis/seurat_out/KRT_MIT_clean_integrated_all_markers_minpct0.25_minlfc0.25_21feb25.txt", col_names = T)
```

## Find Average Expression
```{r}
DefaultAssay(leaf.combined) <- "RNA"

# replace spaces with underscores '_' so ggplot2 doesn't fail
orig.levels <- levels(leaf.combined)
Idents(leaf.combined) <- gsub(pattern = " ", replacement = "_", x = Idents(leaf.combined))
orig.levels <- gsub(pattern = " ", replacement = "_", x = orig.levels)
levels(leaf.combined) <- orig.levels
cluster.averages <- AverageExpression(leaf.combined, return.seurat = TRUE)
cluster.averages

# How can I extract expression matrix for all Cluster 0 cells (perhaps, to load into another package)
cluster_avg.data <- as.matrix(GetAssayData(cluster.averages, layer = "data")[, ])
#write.table(cluster_avg.data, file = "/scratch/ac05869/MIT_KRT_sc_analysis/seurat_out/KRT_MIT_clean_integrated_cluster_avg_normalized_counts_21jan25.txt", sep = "\t", quote = FALSE)
```

# Make Plots

## Look at top several pathway genes
```{r}
#Need to create a file that has your marker genes and some metadata (cell types, etc.). Change all underscores to either dashes or periods

allwin <- read.table("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/allwin_pathay_top2_25feb25.txt", header = TRUE, sep = "\t")
allwin$kratom.id <- gsub("\\.\\d+$", "", allwin$kratom.id) #remove transcript syntax to match seurat object
allwin$kratom.id <- gsub("_", "-", allwin$kratom.id)
allwin <- allwin %>% distinct(kratom.id, .keep_all = T)
  #remove duplicates
head(allwin)

rev_allwin <- allwin[order(nrow(allwin):1),]
```

## Find missing genes
```{r}
DefaultAssay(leaf.combined) <- "RNA"

DotPlot(leaf.combined, features = unique(rev_allwin$kratom.id), 
        ) +
  scale_x_discrete(labels=rev_allwin$gene.abbreviation) +
  scale_color_gradientn(colors = viridis(10, option = "A")[1:9]) +
  labs(y = "Cluster",
       x = "Genes") + 
  coord_flip()
```

## Remove genes
```{r}
#Remove everything that has no expression based on the error messages from making the above plot
#View(allwin) ##see row in which the variable was not found in order to subset
subset <- str_trim(paste(scan("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/missing_in_leaf.txt", what = "character", sep = c(",", " "))))

allwin_subset <- allwin %>%
  filter(! as.character(kratom.id) %in% as.character(subset))

(rev_allwin_subset <- allwin_subset %>% arrange(desc(order))) #another way to do it if your data has "order" column
```

## Make dot plot
```{r}
showtext_auto(enable = FALSE)
#plot only genes with expression
(dotplot_data <- DotPlot(leaf.combined, features = unique(rev_allwin_subset$kratom.id))$data)
(unique(rev_allwin_subset$kratom.id)) #Count if any duplicate gene ID's

dotplot_data %>% 
  inner_join(rev_allwin_subset %>% 
               distinct(kratom.id, .keep_all = T), by = c("features.plot"="kratom.id")) %>%
  mutate(tag = paste(gene.abbreviation, features.plot)) %>%
  ggplot(aes(x = id, y = reorder(tag,order, decreasing = TRUE))) +
  geom_point(aes(size = pct.exp, color = avg.exp.scaled)) +
  scale_color_gradientn(colors = viridis(10, option = "A")[1:9]) +
  labs(y = "Genes",
       x = "Cluster") + 
  theme_classic()

ggsave("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/KRT_MIT_allwin_pathway_top2_hits_25feb25.png", height = 10, width = 12, bg = "white")
```

## Make dot plot split by source (MPI vs UGA)
```{r}
showtext_auto()
#plot only genes with expression
dotplot_data <- DotPlot(leaf.combined, features = unique(rev_allwin_subset$kratom.id), split.by = "source")$data %>%
  mutate(source = case_when(
    str_detect(id, "UGA") ~ "UGA",
    str_detect(id, "MPI") ~ "MPI"
  )) %>%
  mutate(id2 = str_sub(id, start = 1, end = -5))
unique(rev_allwin_subset$kratom.id) #Count if any duplicate gene ID's

dotplot_data %>% 
  inner_join(rev_allwin_subset %>% 
               distinct(kratom.id, .keep_all = T), by = c("features.plot"="kratom.id")) %>%
  mutate(tag = paste(gene.abbreviation, features.plot)) %>%
  ggplot(aes(x = id2, y = reorder(tag,order, decreasing = TRUE))) +
  facet_wrap(~ source) +
  geom_point(aes(size = pct.exp, color = avg.exp.scaled)) +
  theme(text = element_text(size = 26)) +
  scale_color_gradientn(colors = viridis(10, option = "A")[1:9]) +
  labs(y = "Genes",
       x = "Cluster") + 
  theme_classic()

dotplot_data

ggsave("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/by_source_KRT_MIT_allwin_pathway_top2_hits_25feb25.png", height = 10, width = 12, bg = "white")
```

## Look at top hit
```{r}
#Need to create a file that has your marker genes and some metadata (cell types, etc.). Change all underscores to either dashes or periods

allwin <- read.table("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/allwin_top_pathway_gene_leaf.txt", header = TRUE, sep = "\t")
allwin$kratom.id <- gsub("\\.\\d+$", "", allwin$kratom.id) #remove transcript syntax to match seurat object
allwin$kratom.id <- gsub("_", "-", allwin$kratom.id)
allwin <- allwin %>%
  distinct(kratom.id, .keep_all = T) #remove duplicates
head(allwin)

rev_allwin <- allwin[order(nrow(allwin):1),]
```

## Find missing genes
```{r}
DefaultAssay(leaf.combined) <- "RNA"

DotPlot(leaf.combined, features = unique(rev_allwin$kratom.id), 
        ) +
  scale_x_discrete(labels=rev_allwin$gene.abbreviation) +
  scale_color_gradientn(colors = viridis(10, option = "A")[1:9]) +
  labs(y = "Cluster",
       x = "Genes") + 
  coord_flip()

#missing in top hit: Mitsp.v1.03-2G022350 (TDC), used the 4th best hit for TDC (Mitsp.v1.21_1G011780.1)
```

## Make dot plot
```{r}
#plot only genes with expression
(dotplot_data <- DotPlot(leaf.combined, features = unique(rev_allwin_subset$kratom.id))$data)
(unique(rev_allwin_subset$kratom.id)) #Count if any duplicate gene ID's

dotplot_data %>% 
  inner_join(rev_allwin_subset %>% 
               distinct(kratom.id, .keep_all = T), by = c("features.plot"="kratom.id")) %>%
  mutate(tag = paste(gene.abbreviation, features.plot)) %>%
  ggplot(aes(x = id, y = reorder(tag,order, decreasing = TRUE))) +
  geom_point(aes(size = pct.exp, color = avg.exp.scaled)) +
  theme(text = element_text(size = 26)) +
  scale_color_gradientn(colors = viridis(10, option = "A")[1:9]) +
  labs(y = "Genes",
       x = "Cluster") + 
  theme_classic()

ggsave("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/seurat_KRT_MIT_leaf_allwin_top_hit_25feb25.png", height = 10, width = 12, bg = "white")
```

# C. roseus pathway dotplot 
```{r}
cros <- read.table("/scratch/ac05869/MIT_KRT_sc_analysis/cros_allwin_in_kratom.txt", header = TRUE, sep = "\t")
cros$kratom.id <- gsub("\\.\\d+$", "", cros$kratom.id) #remove transcript syntax to match seurat object
cros$kratom.id <- gsub("_", "-", cros$kratom.id)
rev_cros <- cros[order(nrow(cros):1),]
head(rev_cros)
```

## Make dot plot
```{r}
#plot only genes with expression
dotplot_data <- DotPlot(leaf.combined, features = unique(rev_cros$kratom.id))$data

dotplot_data %>% 
  inner_join(rev_cros %>% 
               distinct(kratom.id, .keep_all = T), by = c("features.plot"="kratom.id")) %>%
  mutate(tag = paste(gene.abbreviation, features.plot)) %>%
  ggplot(aes(x = id, y = reorder(tag,order, decreasing = TRUE))) +
  geom_point(aes(size = pct.exp, color = avg.exp.scaled)) +
  theme(text = element_text(size = 26)) +
  scale_color_gradientn(colors = viridis(10, option = "A")[1:9]) +
  labs(y = "Genes",
       x = "Cluster") + 
  theme_classic()

ggsave("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/seurat_KRT_MIT_leaf_cros_allwin_pathway_top_hit_25feb25.png", height = 10, width = 12, bg = "white")
```

## Make dot plot split by source (MPI vs UGA)
```{r}
showtext_auto(enable = FALSE)
#plot only genes with expression
dotplot_data <- DotPlot(leaf.combined, features = unique(rev_cros$kratom.id), split.by = "source")$data %>%
  mutate(source = case_when(
    str_detect(id, "UGA") ~ "UGA",
    str_detect(id, "MPI") ~ "MPI"
  )) %>%
  mutate(id2 = str_sub(id, start = 1, end = -5))

dotplot_data %>% 
  inner_join(rev_cros %>% 
               distinct(kratom.id, .keep_all = T), by = c("features.plot"="kratom.id")) %>%
  mutate(tag = paste(gene.abbreviation, features.plot)) %>%
  ggplot(aes(x = id2, y = reorder(tag,order, decreasing = TRUE))) +
  facet_wrap(~ source) +
  geom_point(aes(size = pct.exp, color = avg.exp.scaled)) +
  theme(text = element_text(size = 26)) +
  scale_color_gradientn(colors = viridis(10, option = "A")[1:9]) +
  labs(y = "Genes",
       x = "Cluster") + 
  theme_classic()

dotplot_data

ggsave("/scratch/ac05869/MIT_KRT_sc_analysis/pathway_data/by_source_KRT_MIT_MEP_IR_Allwin_pathway_25feb25.png", height = 10, width = 12, bg = "white")
```

