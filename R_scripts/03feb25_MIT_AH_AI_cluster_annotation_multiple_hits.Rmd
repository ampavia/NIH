---
title: "MIT_AH_AI_cluster_annotation"
author: "Anne Pavia"
date: "2025-01-27"
output: html_document
---
# Notes:
I used Josh and Anita's poplar marker data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# packages 
```{r}
library(tidyverse)
library(Seurat)
library(readxl)
library(RColorBrewer)
library(rcartocolor)
library(viridis)
library(patchwork)
```
# Pull Seurat data
```{r}
leaf.combined <- readRDS("/scratch/ac05869/nih/kratom/seurat_analysis/mpi_kratom_leaf_mitr.v1/MIT_AH_AI_cleaned_integrated_seurat_14jan25.rds")
DefaultAssay(leaf.combined) <- "RNA"
leaf.combined = JoinLayers(leaf.combined)
leaf.combined.markers <- FindAllMarkers(leaf.combined, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25) #min.pct is the minimum fraction that cells cluster needs to be expressing that gene for it to count. logfc.threshhold is the log-fold change in expression between clusters expressing that gene
```


# Pull marker genes and Seurat markers
```{r}
leaf_markers <- read_csv("/scratch/ac05869/nih/pop_markers/kratom_leaf/MIT_AH_AI_seurat_markers_with_pop_markers_12feb25.csv", col_names = T)
head(leaf_markers)
dim(leaf_markers) #248

leaf_markers2 <- leaf_markers %>% 
  dplyr::select(symbol, cell_type, gene_ID, functional_annotation) %>% 
  # rbind(leaf_markers) %>%
  dplyr::filter(is.na(gene_ID) == F)
```


## Cell type assignment heatmap
# Dotplot

```{r}
DefaultAssay(leaf.combined) <- "RNA"

Marker_dotplot <- DotPlot(leaf.combined, 
                          features = unique(leaf_markers2$gene_ID))

Marker_dotplot_nice_df <- Marker_dotplot$data %>% 
  rownames_to_column(var = "gene_ID") %>%
  full_join(leaf_markers2 %>% 
              distinct(gene_ID, .keep_all = T),
             by = c("features.plot" = "gene_ID")) %>% 
   mutate(cell_type2 = case_when(
    str_detect(cell_type, "meso") ~ "M",
    str_detect(cell_type, "cam") ~ "Cam",
    str_detect(cell_type, "xyl") |
      str_detect(cell_type, "vessel") ~ "X",
    str_detect(cell_type, "phl") |
      str_detect(cell_type, "sieve") ~ "Ph",
    str_detect(cell_type, "com") ~ "Com",
    str_detect(cell_type, "vas") |
      str_detect(cell_type, "cortex") ~ "V",
    str_detect(cell_type, "epi") ~ "E",
    str_detect(cell_type, "guard") ~ "GC",
    str_detect(cell_type, "IPAP") ~ "IP",
    str_detect(cell_type, "idioblast")  ~ "I",
    str_detect(cell_type, "G2")  ~ "G2",
    str_detect(cell_type, "G0/G1")  ~ "G0/G1",
    str_detect(cell_type, "pro") |
    str_detect(cell_type, "Unkn") ~ "Pro",
    str_detect(cell_type, "shoot") ~ "SAM",
    str_detect(cell_type, "trich") ~ "TRI",
    str_detect(cell_type, "ray") ~ "Ray",
  )) %>%
  dplyr::filter(str_detect(cell_type, "shea") == F) %>% 
  mutate(cell_type2 = factor(cell_type2, levels = c(
    "M", "E", "GC", "V", "X", "Ph", "Cam", "Com", "IP", "I", "Pro", "G0/G1", "G2", "SAM", "TRI", "Ray"
  ))) %>% 
  mutate(cell_type3 = as.numeric(cell_type2)) %>% 
  mutate(features.plot = reorder(features.plot, cell_type3, decreasing = T)) %>% 
  dplyr::filter(is.na(avg.exp.scaled) == F)%>%
  mutate(tag = paste(features.plot, cell_type2)) %>%
  mutate(id = factor(id, levels = c(
    "0", "2", "3", "7", "8", "11", "15", "17",
    "1", "6", "10", "14", "16",
    "9","21", "12", "13", "18",
    "22",
    "4", "5","19", "20"
    )))

head(Marker_dotplot_nice_df) #667

#View this and compare
```

## Filter out genes that don't belong in leaf
```{r}
leaf_markers2 <- leaf_markers %>% 
  dplyr::select(symbol, cell_type, gene_ID) %>%
  dplyr::filter(str_detect(gene_ID, "2") == T) %>%
  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.12-1G004200") == F) %>% # root cortext not in leaf
  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.08-2G000560") == F) %>% #guard cell that was expressed with phloem cells
  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.20-2G008400") == F) %>% #under-expressed xylem marker
  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.06-1G021870") == F) %>% #under-expressed xylem marker cluster 19
#  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.12-1G019890") == F) %>% # redundant xylem marker
#  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.16-2G012920") == F) %>% #under-expressed phloem marker
  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.10-2G011550") == F) %>% #under-expressed proliferating marker
#  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.01-2G008870") == F) %>% #under-expressed G0/G1 phase marker
  dplyr::filter(str_detect(gene_ID, "Mitsp.v1.19-2G000490") ==F) %>% # not expressed XYLEM CYSTEINE PEPTIDASE 1
  dplyr::filter(str_detect(cell_type, "shoot") == F) %>%
  dplyr::filter(is.na(gene_ID) == F)
  
Marker_dotplot <- DotPlot(leaf.combined, 
                          features = unique(leaf_markers2$gene_ID)) 
head(Marker_dotplot$data)

Marker_dotplot_nice_df <- Marker_dotplot$data %>% 
  mutate(gene_ID = row.names(.)) %>% 
  mutate(gene_ID = str_sub(gene_ID, end = 15)) %>% 
  full_join(leaf_markers2 %>% 
              distinct(gene_ID, .keep_all = T),
             by = c("features.plot" = "gene_ID")) %>% 
   mutate(cell_type2 = case_when(
    str_detect(cell_type, "meso") ~ "M",
    str_detect(cell_type, "cam") ~ "Cam",
    str_detect(cell_type, "xyl") |
      str_detect(cell_type, "vessel") ~ "X",
    str_detect(cell_type, "phl") |
      str_detect(cell_type, "sieve") ~ "Ph",
    str_detect(cell_type, "com") ~ "Com",
    str_detect(cell_type, "vas") |
      str_detect(cell_type, "cortex") ~ "V",
    str_detect(cell_type, "epi") ~ "E",
    str_detect(cell_type, "guard") ~ "GC",
    str_detect(cell_type, "IPAP") ~ "IP",
    str_detect(cell_type, "idioblast")  ~ "I",
    str_detect(cell_type, "G2")  ~ "G2",
    str_detect(cell_type, "G0/G1")  ~ "G0/G1",
    str_detect(cell_type, "pro") |
    str_detect(cell_type, "Unkn") ~ "Pro",
    str_detect(cell_type, "shoot") ~ "SAM",
    str_detect(cell_type, "trich") ~ "TRI",
    str_detect(cell_type, "ray") ~ "Ray",
  )) %>%
  dplyr::filter(str_detect(cell_type, "shea") == F) %>% 
  mutate(cell_type2 = factor(cell_type2, levels = c(
    "M", "E", "GC", "V", "X", "Ph", "Cam", "Com", "IP", "I", "Pro", "G0/G1", "G2", "SAM", "TRI", "Ray"
  ))) %>% 
  mutate(cell_type3 = as.numeric(cell_type2)) %>% 
  mutate(features.plot = reorder(features.plot, cell_type3, decreasing = T)) %>% 
  dplyr::filter(is.na(avg.exp.scaled) == F)%>%
  mutate(tag = paste(features.plot, cell_type2)) %>%
  mutate(id = factor(id, levels = c(
    "0", "2", "3", "7", "8",
    "1", "6", "10", "14", "16",
    "12", "13", "18",
    "9", "21", 
    "22",
    "4", "5", "14", "16", "17", "19", "20"
    )))

dim(Marker_dotplot_nice_df) #1886
head(Marker_dotplot_nice_df)
```

```{r}
Marker_dot <- Marker_dotplot_nice_df %>% 
  filter(str_detect(cell_type2, "V") == T) %>%
  ggplot(aes(x = id, y = reorder(tag, cell_type3, decreasing = TRUE))) +
  geom_point(aes(size = pct.exp, fill = avg.exp.scaled), shape = 21, color = "white") +
  scale_fill_viridis(option = "A", begin = 0, end = 0.9) +
  guides(size = guide_legend(override.aes = list(fill = "grey40"), nrow = 2)) +
  labs(x = "Cluster",
       y = NULL, 
       fill = "Avg. Exp.",
       size = "% Exp.") +
  theme_classic() +
  theme(text = element_text(size = 10, color = "black"),
        axis.text = element_text(color = "black"),
        legend.position = "top",
        legend.box = "horizontal",
        legend.key.height = unit(0.7, "lines"))

Marker_dot
#ggsave("/scratch/ac05869/nih/kratom/MIT_AH_AI_marked_clusters_10feb25.png", width = 10, height = 8)
```

* M: "0", "2", "3", "7", "8", 
* Epi: "1", "6", "10", "14", "16",
* Xylem: "12", "13", "18,
* Phloem/Cam/Com: "9", "21", 
* IPAP: "22",
* Unspecified: "4", "5", "14", "16", "17", "19", "20"

```{r}
leaf_cell_type_assignment <- data.frame(
  cluster = c(0:22)
) %>% 
  mutate(cell_type = case_when(
    cluster == 0 |
      cluster == 2 |
      cluster == 3 |
      cluster == 7 |
      cluster == 8 | 
      cluster == 11 |
      cluster == 15 ~ "Mesophyll",
    cluster == 1 |
      cluster == 6 |
      cluster == 10 ~ "Epidermis",
    cluster == 12 |
      cluster == 13 |
      cluster == 18 ~ "Xylem",
    cluster == 9 |
      cluster == 21 ~ "Phloem",
    cluster == 22 ~ "IPAP",
    cluster == 4 |
      cluster ==5 |
      cluster ==14 |
      cluster ==16 |
      cluster ==17 |
      cluster ==19 |
      cluster == 20 ~ "Unassigned"
  )) %>% 
  mutate(cell_type = factor(cell_type, 
                            levels = c(
                              "Mesophyll", "Epidermis", "Xylem", "Phloem",
                              "IPAP", 
                              "Unassigned"
                            ))) %>% 
  mutate(cluster = factor(cluster, levels = c(
     "0", "2", "3", "7", "8", "11", "15",
    "1", "6", "10",
    "12", "13", "18",
    "9", "21", 
    "22",
    "4", "5", "14", "16", "17", "19", "20"
    )))
```


```{r}
Leaf_cell_type_strip <- leaf_cell_type_assignment %>% 
  ggplot(aes(x = cluster, y = "" )) +
  geom_tile(aes(fill = cell_type)) +
  scale_fill_manual(values = c(brewer.pal(6, "Accent"), "grey80")) +
  guides(fill = guide_legend(nrow = 3)) +
  labs(fill = "Cell type") +
  theme_void() +
  theme(
    legend.position = "bottom" ,
    text = element_text(size = 14)
  )

Leaf_cell_type_strip

Leaf_cell_type_mkr_text <- Marker_dotplot_nice_df %>% 
  dplyr::filter(id == 0) %>% 
  ggplot(aes(x = "", y = reorder(tag, cell_type3, decreasing = TRUE))) +
  geom_text(aes(label = unique(symbol), fontface = "italic")) +
  theme_void()

blank <- data.frame(
  x = 0,
  y = 0
) %>% 
  ggplot(aes(x, y)) +
  theme_void()

Marker_dot_strip <- wrap_plots(Marker_dot, Leaf_cell_type_mkr_text,
          Leaf_cell_type_strip, blank,
          heights = c(1, 0.03), 
          widths = c(1, 0.2), nrow = 2, ncol = 2)

Marker_dot_strip

#ggsave("/scratch/ac05869/nih/kratom/MIT_AH_AI_cell_type_assignment_plot.svg", height = 8, width = 7.5, bg = "white")
#ggsave("/scratch/ac05869/nih/kratom/MIT_AH_AI_cell_type_assignment_plot.png", height = 6, width = 7.5, bg = "white")
```
# Optional write tables
## Merge seurat cluster top marker file with leaf_markers to identify top markers for each cluster
```{r}
cluster_markers <- read_delim("/scratch/ac05869/nih/kratom_pathway/MIT_AH_AI_clean_integrated_all_markers_minpct0.25_minlfc0.25_with_info_30jan25.txt", delim = "\t", col_names = T) %>% rename("gene_ID" = "ID")
cluster_markers$gene_ID <- gsub(pattern = "_", replacement = "-", cluster_markers$gene_ID)
head(cluster_markers)
head(leaf_markers)

cluster_markers2 <- inner_join(cluster_markers, leaf_markers, by = "gene_ID") %>% 
  group_by(cluster) %>%
  select(1, 11, 2, 13, 12, 16, 8, 9, 10, 15)
head(cluster_markers2)

#remove commas from Reference column in order to write csv file
cluster_markers2 <- cluster_markers2 %>%
  mutate(Reference = str_replace(Reference, ",", " ")) %>%
#           write_csv(file = "~/nih/marker_genes/MIT_AH_AI_all_markers_with_minpct0.25_minlfc0.25_10feb25.csv", quote = "none")
head(cluster_markers2)
```
## Avg normalized counts into long format
```{r}
cluster.averages <- AverageExpression(leaf.combined, return.seurat = TRUE)
cluster_avg.data <- as.matrix(GetAssayData(cluster.averages, layer = "data")[, ])
head(cluster_avg.data)

cluster_avg.data2 <- as.data.frame(cluster_avg.data) %>%
  rownames_to_column(var = "gene_ID") %>%
  pivot_longer(-gene_ID, names_to = "cluster", values_to = "avg_norm_counts")
cluster_avg.data2$cluster <- as.numeric(cluster_avg.data2$cluster)
head(cluster_avg.data2)
```


## View marker genes cluster by cluster
```{r}
cluster_markers_repr <- cluster_markers %>%
  inner_join(cluster_avg.data2, by = c("gene_ID" = "gene_ID", "cluster" = "cluster")) %>%
  group_by(cluster) %>%
  arrange(desc(avg_log2FC), .by_group = T) %>% #arrange in descending order
  slice_max(avg_norm_counts, n = 20) %>%
  select(c(1, 2, 8, 11, 9, 10)) %>%
  mutate(cell_type = case_when(
    cluster == 0 |
      cluster == 2 |
      cluster == 3 |
      cluster == 7 |
      cluster == 8 | 
      cluster == 11 |
      cluster == 15 ~ "Mesophyll",
    cluster == 1 |
      cluster == 6 |
      cluster == 10 ~ "Epidermis",
    cluster == 12 |
      cluster == 13 |
      cluster == 18 ~ "Xylem",
    cluster == 9 |
      cluster == 21 ~ "Phloem",
    cluster == 22 ~ "IPAP",
    cluster == 4 |
      cluster ==5 |
      cluster ==14 |
      cluster ==16 |
      cluster ==17 |
      cluster ==19 |
      cluster == 20 ~ "Unassigned"
    ))
View(cluster_markers_repr)

write_csv(cluster_markers_repr, file = "~/nih/marker_genes/MIT_AH_AI_clusters_top20_markers.csv")

```
